# Дипломная работа.

````bash
$ terraform version
Terraform v1.3.6
on linux_amd64
````

Инициализация Терраформа (без бэкенда!) - создание каталога, сервисных аккаунтов и бакета:
````bash
$ terraform init
$ terraform apply -auto-approve
````

Инициализация командной строки:
````bash
$ yc init
````

Список сервисных аккаунтов
````bash
$ yc iam service-account list
+----------------------+--------------+
|          ID          |     NAME     |
+----------------------+--------------+
| ajet7gh4d9k00ks2e2d0 | terraform-sa |
+----------------------+--------------+
````

Список известных ключей доступа для сервисного аккаунта `terraform-sa`:
````bash
$ yc iam access-key list --service-account-name terraform-sa
+----------------------+----------------------+---------------------------+
|          ID          |  SERVICE ACCOUNT ID  |          KEY ID           |
+----------------------+----------------------+---------------------------+
| ajet7jpmudt5k1s34ko6 | ajet7gh4d9k00ks2e2d0 | YCAJE9hucJpZKrVXFrBZMG8y1 |
+----------------------+----------------------+---------------------------+
````

Генерация ключа доступа для сервисного аккаунта:
````bash
$ yc iam access-key create --service-account-name terraform-sa
access_key:
  id: ajenn0l5ob7sf1l1lubr
  service_account_id: ajet7gh4d9k00ks2e2d0
  created_at: "2023-01-14T13:30:18.820296969Z"
  key_id: YCAJEJwH-q1TcCoZ-DnJosLfn
secret: YCO-SHAm0ynM8V4L4jE4c4Gp0VhbhvyO3ggZ6aZb
````

> Значение секретного ключа (поле `secret`) повторно получить невозможно, поэтому его следует сразу сохранить
> в безопасном месте!

Обновить ключи доступа в переменных окружения в файле `~/.zshrc`:

````bash
export YC_STORAGE_ACCESS_KEY=<Значение key_id>
export YC_STORAGE_SECRET_KEY=<Значение secret>
````

Обязательно реинициализировать консоль, чтобы новые значения переменных вступили в силу:
````bash
$ source ~/.zshrc
````

Можно инициализировать командой:
````bash
$ terraform init \
-backend-config="endpoint=storage.yandexcloud.net" \
-backend-config="bucket=tf-backend" \
-backend-config="region=ru-central1-a" \
-backend-config="key=tfstate" \
-backend-config="access_key=$AWS_ACCESS_KEY_ID" \
-backend-config="secret_key=$AWS_SECRET_ACCESS_KEY" \
-backend-config="skip_region_validation=true" \
-backend-config="skip_credentials_validation=true" \
-backend-config="workspace_key_prefix=tf-state" \
-reconfigure

Initializing the backend...
Do you want to copy existing state to the new backend?
  Pre-existing state was found while migrating the previous "local" backend to the
  newly configured "s3" backend. No existing state was found in the newly
  configured "s3" backend. Do you want to copy this state to the new "s3"
  backend? Enter "yes" to copy and "no" to start with an empty state.

  Enter a value: yes


Successfully configured the backend "s3"! Terraform will automatically
use this backend unless the backend configuration changes.

Initializing provider plugins...
- Reusing previous version of yandex-cloud/yandex from the dependency lock file
- Using previously-installed yandex-cloud/yandex v0.84.0

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
````

> terraform init -reconfigure - Reconfigure a backend, ignoring any saved configuration.

Раскомментировать бэкенд (access_key и secret_key не нужны) и повторно инициализировать Терраформ:
````bash
$ terraform init

Initializing the backend...
Do you want to copy existing state to the new backend?
  Pre-existing state was found while migrating the previous "local" backend to the
  newly configured "s3" backend. No existing state was found in the newly
  configured "s3" backend. Do you want to copy this state to the new "s3"
  backend? Enter "yes" to copy and "no" to start with an empty state.

  Enter a value: yes
...
````

В бакете 'tf-backend' должен появиться файл `tfstate`.

![tfstate.png](images%2Ftfstate.png)

workspace_key_prefix/workspace_name/key

workspace_key_prefix - default is `env:`


Инициализируем Терраформ в другой папке:
````bash
$ cd /run/media/oleg/Second/Netology/devops-diploma-yandexcloud/16-diploma-yc/terraform/stage_100
$ terraform init
$ terraform apply -auto-approve
````

Создаём рабочие пространства:

````bash
$ cd /run/media/oleg/Second/Netology/devops-diploma-yandexcloud/16-diploma-yc/terraform/stage_000
$ terraform workspace new stage
$ terraform workspace new prod
$ terraform workspace list    
  default
* prod
  stage

$ terraform workspace select stage
Switched to workspace "stage".

$ terraform workspace show
stage
````


---

Терраформ использует сохраняемые состояния для отслеживания и управления ресурсам.
Здесь существует два варианта - интеграция с Terraform Cloud или использовать бэкенд, который определяет,
где именно Терраформу сохранять свои данные.
Такой подход позволяет нескольким пользователям иметь доступ к сохраняемым состояниям
и совместно работать с ресурсами.

Терраформ сохраняет конфигурацию в виде простого текста в двух файлах:
- `.terraform/terraform.tfstate` - содержит конфигурацию бэкенда для текущей рабочей директории;
- файлы планов, которые используют информацию из файла `.terraform/terraform.tfstate` во время создания плана чтобы
  гарантировать применение плана к правильному набору инфраструктуры;

При применении предварительного сохранённого плана Терраформ использует конфигурацию бэкенда, сохраненную в этом файле
вместо текущих настроект бэкенда.

Когда изменяется конфигурация бэкенда, то нужно снова выполнить `terraform init` для валидации и конфигурировании
бекенда до выполнения операций `plan`, `apply` или `state`.

После выполнения `terraform init` Терраформ локально создаст директорию `.terraform/`. Эта директория содержит последние
бэкенд конфигурации, включая все аутентификационные параметры, предоставленные посредством Terraform CLI.
Не следует сохранять директорию `.terraform/` в Git-репозитории, поскольку это может повлечь утечку чувствительных
данных.

Локальная конфигурация бэкенда отличается и полностью отделена от файла `terraform.tfstate`, хранящего данные состояния
о реальной инфраструктуре. Терраформ сохраняет файл `terraform.tfstate` в удалённом бэкенде.

При изменении бэкендов Терраформ предоставляет возможность мигрировать состояние в новый бэкенд. Это позволяет
переносить бэкенды без потери существующего состояния.

> ВАЖНО: Перед миграцией в новый бэкенд настоятельно рекомендуется вручную сохранить состояние путем копирования
> файла `terraform.tfstate`

---
