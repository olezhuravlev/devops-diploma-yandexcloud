# Дипломная работа.

````bash
$ terraform version
Terraform v1.3.6
on linux_amd64
````

Инициализация Терраформа (без бэкенда!) - создание каталога, сервисных аккаунтов и бакета:
````bash
$ terraform init
````

Создаём рабочие пространства:
````bash
$ cd /run/media/oleg/Second/Netology/devops-diploma-yandexcloud/16-diploma-yc/terraform/stage_000
$ terraform workspace new stage
$ terraform workspace new prod
$ terraform workspace list    
  default
* prod
  stage

$ terraform workspace select stage
Switched to workspace "stage".

$ terraform workspace show
stage
````

````bash
$ terraform apply -auto-approve
````

Инициализация командной строки:
````bash
$ yc init
````

Список сервисных аккаунтов
````bash
$ yc iam service-account list
+----------------------+--------------+
|          ID          |     NAME     |
+----------------------+--------------+
| ajeascjvdskprkmahd4s | terraform-sa |
+----------------------+--------------+
````

Список известных ключей доступа для сервисного аккаунта `terraform-sa`:
````bash
$ yc iam access-key list --service-account-name terraform-sa
+----------------------+----------------------+---------------------------+
|          ID          |  SERVICE ACCOUNT ID  |          KEY ID           |
+----------------------+----------------------+---------------------------+
| aje5np036p1sq10ukp44 | ajeascjvdskprkmahd4s | YCAJEClBtgxwoxxGia1jA3ZNn |
+----------------------+----------------------+---------------------------+
````

Генерация ключа доступа для сервисного аккаунта:
````bash
$ yc iam access-key create --service-account-name terraform-sa
access_key:
  id: ajef0k6nrp3048uttd1f
  service_account_id: ajeascjvdskprkmahd4s
  created_at: "2023-01-14T15:02:42.309490286Z"
  key_id: YCAJEUSjo0kr44b7D_S_PwpiU
secret: YCNDbxG5200KuBLLx3T-TquofcBQThVccGEMdE5k
````

> Значение секретного ключа (поле `secret`) повторно получить невозможно, поэтому его следует сразу сохранить
> в безопасном месте!

Указать ключи доступа в объявлении переменных окружения в файле `~/.zshrc`.
````bash
export YC_STORAGE_ACCESS_KEY=<Значение key_id>
export YC_STORAGE_SECRET_KEY=<Значение secret>
````

Обязательно реинициализировать консоль, чтобы новые значения переменных вступили в силу:
````bash
$ source ~/.zshrc
````

Раскомментировать бэкенд (access_key и secret_key не нужны) и повторно инициализировать Терраформ:
````bash
$ terraform init

Initializing the backend...
Do you want to copy existing state to the new backend?
  Pre-existing state was found while migrating the previous "local" backend to the
  newly configured "s3" backend. No existing state was found in the newly
  configured "s3" backend. Do you want to copy this state to the new "s3"
  backend? Enter "yes" to copy and "no" to start with an empty state.

  Enter a value: yes
...
````

> Можно инициализировать бэкенд командой:
> ````bash
> $ terraform init \
> -backend-config="endpoint=storage.yandexcloud.net" \
> -backend-config="bucket=tf-backend" \
> -backend-config="region=ru-central1-a" \
> -backend-config="key=tfstate" \
> -backend-config="access_key=$AWS_ACCESS_KEY_ID" \
> -backend-config="secret_key=$AWS_SECRET_ACCESS_KEY" \
> -backend-config="skip_region_validation=true" \
> -backend-config="skip_credentials_validation=true" \
> -backend-config="workspace_key_prefix=tf-state" \
> -reconfigure
>
> Initializing the backend...
> Do you want to copy existing state to the new backend?
>   Pre-existing state was found while migrating the previous "local" backend to the
>   newly configured "s3" backend. No existing state was found in the newly
>   configured "s3" backend. Do you want to copy this state to the new "s3"
>   backend? Enter "yes" to copy and "no" to start with an empty state.
>
>   Enter a value: yes
> ...
> ````
> 
> Для последующей реконфигурации бэкенда чтобы игнорировать сохраненные конфигурации можно выполнить:
> `terraform init -reconfigure`

Если инициализация бэкенда производилась в рабочем пространстве, отличном от `default`, то в бакете
появиться папка с именем, заданным в параметре `workspace_key_prefix` бэкенда (если параметр не задавался,
то его значение по умолчанию -  `env:`). В этой папке будет лежать другая папка с именем текущего
рабочего пространства, а уже в ней - файл с именем, заданным в параметре `key` бэкенда.

|                                            |                                                        |                                                                        |
|:------------------------------------------:|:------------------------------------------------------:|:----------------------------------------------------------------------:|
| ![tfstate_ws.png](images%2Ftfstate_ws.png) | ![tfstate_ws_stage.png](images%2Ftfstate_ws_stage.png) | ![tfstate_ws_stage_tfstate.png](images%2Ftfstate_ws_stage_tfstate.png) |

Если использовалось рабочее пространство `default`, то файл `tfstate` будет расположен непосредственно
в корне бакета.

![tfstate.png](images%2Ftfstate.png)

workspace_key_prefix/workspace_name/key

workspace_key_prefix - default is `env:`


Инициализируем Терраформ в другой папке:
````bash
$ cd /run/media/oleg/Second/Netology/devops-diploma-yandexcloud/16-diploma-yc/terraform/stage_100
$ terraform init
#$ terraform apply -auto-approve
````

````bash
$ terraform workspace new stage
Created and switched to workspace "stage"!

You're now on a new, empty workspace. Workspaces isolate their state,
so if you run "terraform plan" Terraform will not see any existing state
for this configuration.
````

````bash
$ terraform apply -auto-approve
````

---

Терраформ использует сохраняемые состояния для отслеживания и управления ресурсам.
Здесь существует два варианта - интеграция с Terraform Cloud или использовать бэкенд, который определяет,
где именно Терраформу сохранять свои данные.
Такой подход позволяет нескольким пользователям иметь доступ к сохраняемым состояниям
и совместно работать с ресурсами.

Терраформ сохраняет конфигурацию в виде простого текста в двух файлах:
- `.terraform/terraform.tfstate` - содержит конфигурацию бэкенда для текущей рабочей директории;
- файлы планов, которые используют информацию из файла `.terraform/terraform.tfstate` во время создания плана чтобы
  гарантировать применение плана к правильному набору инфраструктуры;

При применении предварительного сохранённого плана Терраформ использует конфигурацию бэкенда, сохраненную в этом файле
вместо текущих настроект бэкенда.

Когда изменяется конфигурация бэкенда, то нужно снова выполнить `terraform init` для валидации и конфигурировании
бекенда до выполнения операций `plan`, `apply` или `state`.

После выполнения `terraform init` Терраформ локально создаст директорию `.terraform/`. Эта директория содержит последние
бэкенд конфигурации, включая все аутентификационные параметры, предоставленные посредством Terraform CLI.
Не следует сохранять директорию `.terraform/` в Git-репозитории, поскольку это может повлечь утечку чувствительных
данных.

Локальная конфигурация бэкенда отличается и полностью отделена от файла `terraform.tfstate`, хранящего данные состояния
о реальной инфраструктуре. Терраформ сохраняет файл `terraform.tfstate` в удалённом бэкенде.

При изменении бэкендов Терраформ предоставляет возможность мигрировать состояние в новый бэкенд. Это позволяет
переносить бэкенды без потери существующего состояния.

> ВАЖНО: Перед миграцией в новый бэкенд настоятельно рекомендуется вручную сохранить состояние путем копирования
> файла `terraform.tfstate`

---
